name: Create Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Calculate new version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

          # Strip v prefix for semver parsing
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "${{ github.event.inputs.bump_type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "new_tag=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Bumping $LATEST_TAG -> v${NEW_VERSION} (${{ github.event.inputs.bump_type }})"

      - name: Generate changelog with git-cliff
        id: cliff
        uses: orhun/git-cliff-action@c93ef52f3d0ddcdcc9bd5447d98d458a11cd4f72 # v4.7.1
        with:
          config: cliff.toml
          args: --latest --tag ${{ steps.version.outputs.new_tag }} --strip header
        env:
          OUTPUT: CLIFF_NOTES.md
          GITHUB_REPO: ${{ github.repository }}

      - name: Extract manual notes from ## next
        run: go run ./scripts/changelog extract --section next --strip-comments > MANUAL_NOTES.md

      - name: Merge changelog notes
        run: |
          go run ./scripts/changelog merge \
            --manual MANUAL_NOTES.md \
            --generated CLIFF_NOTES.md \
            --output MERGED_NOTES.md

      - name: Update CHANGELOG.md
        run: |
          go run ./scripts/changelog update \
            --version "${{ steps.version.outputs.new_version }}" \
            --notes MERGED_NOTES.md

      - name: Create release branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          BRANCH="release/${NEW_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add CHANGELOG.md
          git commit -m "chore: release ${NEW_TAG}"
          git push origin "$BRANCH"

          NOTES=$(cat MERGED_NOTES.md)
          cat <<EOF > PR_BODY.md
## Release ${NEW_TAG}

${NOTES}

---
*Auto-generated release PR. Review the changelog, approve, and merge to publish the release.*
EOF
          gh pr create \
            --title "release: ${NEW_TAG}" \
            --body-file PR_BODY.md \
            --base main \
            --head "$BRANCH"

  finalize-release:
    if: >-
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Extract version from branch
        id: version
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          TAG="${BRANCH#release/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Finalizing release $TAG"

      - name: Extract changelog notes
        run: |
          go run ./scripts/changelog extract \
            --section "${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "::warning::No changelog entry found. Release notes will be empty."
          fi

      - name: Create tag and GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file RELEASE_NOTES.md

      - name: Delete release branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          git push origin --delete "$BRANCH" || true
