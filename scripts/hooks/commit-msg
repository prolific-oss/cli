#!/usr/bin/env bash
#
# Git commit-msg hook
# Enforces conventional commit format on the commit subject line.
#

commit_msg_file="$1"
subject=$(head -n 1 "$commit_msg_file")

# Skip merge commits
if [[ "$subject" =~ ^Merge\  ]]; then
  exit 0
fi

# Skip fixup/squash commits (generated by git commit --fixup/--squash)
if [[ "$subject" =~ ^(fixup|squash)!\  ]]; then
  exit 0
fi

pattern="^(feat|fix|docs|refactor|test|chore|ci|build|perf|style|revert)(\([a-zA-Z0-9_/-]+\))?: .+"

if ! [[ "$subject" =~ $pattern ]]; then
  printf 'ðŸ”´  [FAIL] Invalid commit message format.\n\n'
  printf 'Expected: <type>(<scope>): <description>\n'
  printf 'Example:  feat(DCP-123): add new feature\n'
  printf 'Example:  fix: correct typo in output\n\n'
  printf 'Valid types: feat, fix, docs, refactor, test, chore, ci, build, perf, style, revert\n'
  printf 'Scope is optional.\n\n'
  printf 'Your message: %s\n' "$subject"
  exit 1
fi
